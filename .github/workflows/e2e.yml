name: E2E Tests

on:
  workflow_run:
    workflows: ["CI Pipeline"] 
    types:
      - completed
    branches: [ main ]
  workflow_dispatch: 

jobs:
  playwright-e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Only run if CI passed or manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # Start application with Docker Compose (from root)
      - name: Start Docker Compose services
        run: |
          echo "Starting all services..."
          docker compose up -d
          echo "Services started, waiting for them to be ready..."
      
      - name: Wait for database
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker compose exec -T db pg_isready -U postgres; do sleep 2; done'
      
      - name: Wait for backend
        run: |
          echo "Waiting for backend API..."
          timeout 90 bash -c 'until curl -f http://localhost:3000/health || curl -f http://localhost:3000; do sleep 3; done'
      
      - name: Wait for frontend
        run: |
          echo "Waiting for frontend..."
          timeout 90 bash -c 'until curl -f http://localhost:5173; do sleep 3; done'
      
      - name: Check running containers
        run: |
          echo "=== Running Containers ==="
          docker compose ps
      
      - name: Install Playwright dependencies
        working-directory: ./e2e
        run: |
          npm ci
          npx playwright install --with-deps
      
      - name: Run Playwright E2E tests
        working-directory: ./e2e
        run: npx playwright test
        env:
          BASE_URL: http://localhost:5173
          CI: true
      
      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 30
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: e2e/test-results/
          retention-days: 7
      
      - name: Show container logs on failure
        if: failure()
        run: |
          echo "======================================"
          echo "BACKEND LOGS"
          echo "======================================"
          docker compose logs backend
          echo ""
          echo "======================================"
          echo "FRONTEND LOGS"
          echo "======================================"
          docker compose logs frontend
          echo ""
          echo "======================================"
          echo "DATABASE LOGS"
          echo "======================================"
          docker compose logs db
      
      - name: Stop and remove all containers
        if: always()
        run: |
          echo "Stopping all containers..."
          docker compose down -v --remove-orphans
          echo "Containers stopped and removed"
      
      - name: Clean up Docker resources
        if: always()
        run: |
          echo "Final cleanup..."
          docker system prune -f